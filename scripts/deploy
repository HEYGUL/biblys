#!/bin/sh

# Immediatly exit if a command fails
set -e

if [ $# -lt 2 ]; then
  echo 1>&2 "usage: deploy {site} {version}"
  exit 2
elif [ $# -gt 2 ]; then
  echo 1>&2 "usage: deploy {site} {version}"
  exit 2
fi

site=$1
version=$2
current=$(ssh biblys "cd ~/cloud/$site && git describe --tags")

echo "> Deploying version $version on site $site..."

echo "> Version currently deployed on $site: $current"

echo "> Fetching latest changes from repository..."
ssh biblys "cd ~/cloud/$site && git fetch"

echo "> Changing to tag $version..."
ssh biblys "cd ~/cloud/$site && git checkout $version"

echo "> Installing dependencies..."
ssh biblys "cd ~/cloud/$site && composer install"

echo "> âœ…  Version $version has been deployed on $site"
